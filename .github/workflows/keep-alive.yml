# GitHub Actions å®šæ—¶é‡æ–°éƒ¨ç½²ä¿æ´»
name: Keep Streamlit App Alive

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯8å°æ—¶é‡æ–°æ¨é€ä¸€æ¬¡ï¼ˆé¿å…12å°æ—¶ç¡çœ æœºåˆ¶ï¼‰
    - cron: '0 */8 * * *'

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: åˆ›å»ºç©ºæäº¤å¹¶æ¨é€ä»¥è§¦å‘é‡æ–°éƒ¨ç½²
        id: keep-alive
        run: |
          echo "å¼€å§‹ä¿æ´»æµç¨‹ - $(date)"
          git pull origin main || git pull origin master || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
          
          # åˆ›å»ºç©ºæäº¤ä»¥è§¦å‘Streamlité‡æ–°éƒ¨ç½²
          git commit --allow-empty -m "ğŸ”„ è‡ªåŠ¨ä¿æ´»: $(date '+%Y-%m-%d %H:%M:%S UTC') - é˜²æ­¢åº”ç”¨ç¡çœ "
          
          # æ¨é€åˆ°è¿œç¨‹ä»“åº“è§¦å‘é‡æ–°éƒ¨ç½²
          git push
          
          echo "ä¿æ´»å®Œæˆ - Streamlitåº”ç”¨å°†é‡æ–°éƒ¨ç½²å¹¶ä¿æŒæ´»è·ƒ"
        continue-on-error: true

      - name: ç”ŸæˆREADME.mdæ–‡ä»¶
        if: always()
        run: |
          # è·å–å½“å‰æ—¶é—´æˆ³ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          TIMESTAMP=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          
          # æ£€æŸ¥ä¸Šä¸€æ­¥æ˜¯å¦æˆåŠŸ
          if [ "${{ steps.keep-alive.outcome }}" = "success" ]; then
            STATUS="âœ… ä¿æ´»æˆåŠŸ"
          else
            STATUS="âŒ ä¿æ´»å¤±è´¥"
          fi
          
          # åˆ›å»ºREADME.mdå†…å®¹ï¼ˆç›´æ¥è¦†ç›–ï¼‰
          cat > README.md << EOF
          # Streamlité¡¹ç›®ä¿æ´»

          **æœ€åè¿è¡Œæ—¶é—´**: \`$TIMESTAMP\`

          **è¿è¡Œç»“æœ**: <br>
          $STATUS
          EOF
          
          echo "README.mdå·²ç”Ÿæˆï¼Œå†…å®¹å¦‚ä¸‹ï¼š"
          cat README.md

      - name: æäº¤å¹¶æ¨é€README.md
        if: always()
        run: |
          git add README.md
          git commit -m "ğŸ“ æ›´æ–°ä¿æ´»çŠ¶æ€ - $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "README.mdå·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"

      - name: Delete old workflow runs
        uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          repository: ${{ github.repository }}
          older-than-seconds: 3600  # åˆ é™¤1å°æ—¶å‰çš„è®°å½•
